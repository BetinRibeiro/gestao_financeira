<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registros Vencidos â€¢ Entradas/SaÃ­das</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/f6adf96490.js" crossorigin="anonymous"></script>
  <style>
    .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
    .card-hover { transition: all .2s ease; }
    .card-hover:hover { transform: translateY(-3px); }
    
         .gradient-bg {
         background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
         }
         .card-hover:hover {
         transform: translateY(-5px);
         box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
         }
         .card {
         transition: all 0.3s ease;
         }
         .fade-in {
         animation: fadeIn 0.5s ease-in;
         }
         @keyframes fadeIn {
         from { opacity: 0; transform: translateY(20px); }
         to { opacity: 1; transform: translateY(0); }
         }
      </style>
</head>
<body class="min-h-screen gradient-bg text-gray-100">
  <div class="container mx-auto px-4 py-8">

    <!-- Header -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-8">
      <a href="dashboard.html" class="block hover:bg-blue-800/40 p-4 rounded transition duration-200">
        <div>
          <h1 class="text-3xl font-bold">Registros Vencidos</h1>
          <p class="text-blue-200">Entradas/SaÃ­das com vencimento anterior a hoje e nÃ£o liquidadas</p>
        </div>
      </a>
      <div class="mt-4 md:mt-0 flex items-center gap-2">
        <select id="filtro-tipo" class="px-3 py-2 rounded text-gray-900">
          <option value="entrada">Entradas</option>
          <option value="saida">SaÃ­das</option>
        </select>
        <button id="btnAtualizar" class="px-4 py-2 bg-white text-blue-700 rounded-lg font-semibold hover:bg-blue-50 transition">
          <i class="fa-solid fa-rotate-right mr-2"></i>Atualizar
        </button>
      </div>
    </header>

    <!-- Cards resumo -->
    <section class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
      <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 card-hover">
        <div class="text-sm text-blue-200">Quantidade</div>
        <div id="resumo-quantidade" class="text-2xl font-bold">0</div>
      </div>
      <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 card-hover">
        <div class="text-sm text-blue-200">Valor Total</div>
        <div id="resumo-total" class="text-2xl font-bold">R$ 0,00</div>
      </div>
      <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 card-hover">
        <div class="text-sm text-blue-200">Atraso MÃ©dio (dias)</div>
        <div id="resumo-media" class="text-2xl font-bold">0</div>
      </div>
    </section>

    <!-- Tabela desktop -->
    <div class="hidden md:block bg-white/10 backdrop-blur-sm rounded-xl overflow-hidden">
      <table class="w-full">
        <thead class="border-b border-white/20">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Categoria</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">DescriÃ§Ã£o</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Valor</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Vencimento</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Dias em atraso</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
            <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody id="tbody-overdue" class="divide-y divide-white/10"></tbody>
      </table>
    </div>

    <!-- VersÃ£o mobile -->
    <div id="list-mobile" class="md:hidden space-y-4"></div>

  </div>

  <script>
    // ======= UtilitÃ¡rios =======
    const categoriaMap = {
      venda_a_prazo: "Venda a Prazo",
      venda_a_vista: "Venda Ã  Vista",
      outro_entrada: "Outra Entrada",
      pagamento_mercadoria: "Pagamento Mercadoria",
      despesa_pessoal: "Despesa Pessoal",
      despesa_marketing: "Despesa Marketing",
      despesa_operacional: "Despesa Operacional",
      imposto: "Imposto",
      outro_saida: "Outra SaÃ­da"
    };

    function formatCurrency(value) {
      const v = Number(value) || 0;
      return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function formatDateBR(yyyy_mm_dd) {
      if (!yyyy_mm_dd) return "";
      const [y, m, d] = yyyy_mm_dd.split("-").map(Number);
      if (!y || !m || !d) return "";
      return new Date(y, m - 1, d).toLocaleDateString("pt-BR");
    }

    function ymdLocal(d) {
      // Gera "YYYY-MM-DD" em horÃ¡rio local (sem fuso atrapalhar)
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function diffDias(fromYMD, toYMD) {
      const [fy, fm, fd] = fromYMD.split("-").map(Number);
      const [ty, tm, td] = toYMD.split("-").map(Number);
      const from = new Date(fy, fm - 1, fd);
      const to = new Date(ty, tm - 1, td);
      return Math.max(0, Math.floor((to - from) / (1000 * 60 * 60 * 24)));
    }

    // ======= IndexedDB =======
    let db;

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open("financeDB", 1);
        req.onsuccess = e => { db = e.target.result; resolve(db); };
        req.onerror = e => reject(e.target.error);
      });
    }

    // Lista registros vencidos por tipo (entrada/saida)
    function fetchOverdueByType(tipo) {
      return new Promise((resolve, reject) => {
        const todayStr = ymdLocal(new Date());
        const tx = db.transaction(["records"], "readonly");
        const store = tx.objectStore("records");

        const result = [];
        const cursorReq = store.openCursor();

        cursorReq.onsuccess = e => {
          const cursor = e.target.result;
          if (!cursor) { resolve(result); return; }

          const r = cursor.value || {};
          const status = (r.status || "").toLowerCase();
          const tipoReg = (r.tipo || "").toLowerCase();
          const venc = r.vencimento || ""; // esperado YYYY-MM-DD

          // Filtros:
          // - tipo igual ao selecionado
          // - status != 'liquidada'
          // - vencimento < hoje (comparando strings YYYY-MM-DD)
          if (
            tipoReg === tipo &&
            status !== "liquidada" &&
            venc &&
            venc < todayStr
          ) {
            result.push(r);
          }
          cursor.continue();
        };

        cursorReq.onerror = e => reject(e.target.error);
      });
    }

    // Marcar como pago (liquidada = hoje)
    function markAsPaid(id) {
      const todayStr = ymdLocal(new Date());
      const tx = db.transaction(["records"], "readwrite");
      const store = tx.objectStore("records");
      const getReq = store.get(id);

      getReq.onsuccess = () => {
        const rec = getReq.result;
        if (!rec) return;

        rec.status = "liquidada";
        rec.liquidacao = todayStr;
        rec.updatedAt = new Date().toISOString();

        const putReq = store.put(rec);
        putReq.onsuccess = () => {
          // Recarrega mantendo o filtro atual
          const tipoAtual = document.getElementById("filtro-tipo").value;
          loadAndRender(tipoAtual);
        };
        putReq.onerror = () => alert("Erro ao marcar como pago.");
      };
      getReq.onerror = () => alert("Erro ao buscar registro para pagamento.");
    }

    // ======= Render =======
    function render(overdue) {
      // Ordena por vencimento asc
      overdue.sort((a, b) => (a.vencimento || "").localeCompare(b.vencimento || ""));

      // Resumo
      const todayStr = ymdLocal(new Date());
      const total = overdue.reduce((acc, r) => acc + (Number(r.valor) || 0), 0);
      const medias = overdue.map(r => diffDias(r.vencimento, todayStr));
      const mediaDias = medias.length ? Math.round(medias.reduce((a,b)=>a+b,0) / medias.length) : 0;
      document.getElementById("resumo-quantidade").textContent = overdue.length;
      document.getElementById("resumo-total").textContent = formatCurrency(total);
      document.getElementById("resumo-media").textContent = mediaDias;

      // Tabela desktop
      const tbody = document.getElementById("tbody-overdue");
      tbody.innerHTML = "";
      if (overdue.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-4">Nenhum registro vencido ðŸŽ‰</td></tr>`;
      } else {
        overdue.forEach(r => {
          const dias = diffDias(r.vencimento, todayStr);
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">${categoriaMap[r.categoria] || r.categoria || ""}</td>
            <td class="px-6 py-4 whitespace-nowrap">${r.descricao || ""}</td>
            <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(r.valor)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-red-200 font-semibold">${formatDateBR(r.vencimento)}</td>
            <td class="px-6 py-4 whitespace-nowrap">${dias}</td>
            <td class="px-6 py-4 whitespace-nowrap capitalize">${(r.status || "").toLowerCase()}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right">
              <button class="text-emerald-300 hover:text-emerald-100 mr-3" data-id="${r.id}" title="Marcar como pago">
                <i class="fas fa-check-circle"></i>
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      // Mobile
      const mobile = document.getElementById("list-mobile");
      mobile.innerHTML = "";
      if (overdue.length === 0) {
        mobile.innerHTML = `<div class="bg-white/10 rounded-xl p-4">Nenhum registro vencido ðŸŽ‰</div>`;
      } else {
        overdue.forEach(r => {
          const dias = diffDias(r.vencimento, todayStr);
          const card = document.createElement("div");
          card.className = "bg-white/10 backdrop-blur-sm rounded-xl p-4";
          card.innerHTML = `
            <div class="flex justify-between">
              <div>
                <div class="text-sm text-blue-200">${categoriaMap[r.categoria] || r.categoria || ""}</div>
                <div class="font-semibold">${r.descricao || ""}</div>
              </div>
              <div class="text-right">
                <div class="font-bold">${formatCurrency(r.valor)}</div>
                <div class="text-red-200">Venc: ${formatDateBR(r.vencimento)}</div>
                <div class="text-sm">Atraso: ${dias}d</div>
              </div>
            </div>
            <div class="mt-3 flex justify-end">
              <button class="px-3 py-1 bg-emerald-500 text-white rounded" data-id="${r.id}" title="Marcar como pago">
                <i class="fas fa-check-circle mr-1"></i>Pagar
              </button>
            </div>
          `;
          mobile.appendChild(card);
        });
      }

      // DelegaÃ§Ã£o de clique (marcar como pago)
      // Desktop
      tbody.onclick = (ev) => {
        const btn = ev.target.closest("button");
        if (!btn) return;
        const id = btn.getAttribute("data-id");
        if (!id) return;
        markAsPaid(id);
      };
      // Mobile
      mobile.onclick = (ev) => {
        const btn = ev.target.closest("button");
        if (!btn) return;
        const id = btn.getAttribute("data-id");
        if (!id) return;
        markAsPaid(id);
      };
    }

    async function loadAndRender(tipo) {
      try {
        await openDB();
        const data = await fetchOverdueByType(tipo);
        render(data);
      } catch (e) {
        console.error(e);
        alert("Erro ao carregar registros vencidos.");
      }
    }

    // ======= Boot =======
    document.addEventListener("DOMContentLoaded", () => {
      const filtro = document.getElementById("filtro-tipo");
      const btnAtualizar = document.getElementById("btnAtualizar");

      // Carrega padrÃ£o (Entradas)
      loadAndRender(filtro.value);

      filtro.addEventListener("change", () => loadAndRender(filtro.value));
      btnAtualizar.addEventListener("click", () => loadAndRender(filtro.value));
    });

    // ProteÃ§Ã£o simples de login (opcional, igual ao seu)
    if (localStorage.getItem("logado") !== "true") {
      // window.location.href = "index.html";
    }
  </script>

<script>
  // ðŸš¨ Se nÃ£o estiver logado, manda de volta para o index
  if (localStorage.getItem("logado") !== "true") {
    window.location.href = "index.html"; // ou login.html, dependendo do seu arquivo
  }
</script>
</body>
</html>
